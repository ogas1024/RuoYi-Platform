# 课程资源分享 API 文档（v2）

更新时间：2025-10-18

## 概览
- 架构：前台门户（/portal 只读查询）+ 后台管理（/manage 增删改审）。所有接口需登录。
- 业务：专业 → 课程 → 资源；资源支持压缩包（OSS）或外链；创建/编辑均进入审核流转。
- 角色：普通用户（user）、专业负责人（major_lead）、管理员（admin/super_admin）。
- 重要说明：普通用户要执行“上传/编辑/下架/重新上架”等写操作，必须被授予对应 `manage:*` 按钮级权限（详见“权限与鉴权”）。

## 约定与通用
- 鉴权：统一请求头 `Authorization: Bearer <token>`。
- 基础路径：门户只读 `/portal`；后台管理 `/manage`。
- 分页：`pageNum`（默1），`pageSize`（默10，建议≤50）；返回 `{ rows, total }`。
- 排序：`orderByColumn`（白名单：create_time, download_count 等），`isAsc`（asc/desc）。
- 时间格式：`yyyy-MM-dd HH:mm:ss`。
- 响应包：
  - 成功：`{ code:200, msg:'成功', data: {...} }` 或 `{ code:200, rows:[...], total:n }`
  - 失败：`{ code:4xx/5xx, msg:'错误说明' }`
- 错误码：
  - 400 参数错误/校验失败（含重复冲突）
  - 401 未登录；403 无权限；404 不存在
  - 409 状态冲突（如非待审不可审核）
  - 413 负载过大（文件超限）
- 幂等与唯一：
  - 文件：`(courseId, resourceType, fileHash)` 唯一
  - 外链：`(courseId, resourceType, linkUrl)` 唯一（规范化：去空格、去尾斜杠、小写域名）
- 文件限制：仅 zip/rar/7z/tar/tar.gz/tar.bz2/tar.xz；≤100MB；服务端二次校验。

## 权限与鉴权
- 门户查询（/portal）：登录即可，无需 `manage:*` 权限。
- 普通用户写操作（/manage）：需授予至少以下权限：
  - `manage:upload:oss`, `manage:courseResource:add`, `manage:courseResource:edit`, `manage:courseResource:remove`, `manage:courseResource:offline`, `manage:courseResource:online`
- 审核与课程维护：
  - 专业负责人：本专业范围内 `manage:course:*` 与 `manage:courseResource:approve|reject`
  - 管理员：全量 `manage:*`

## 数据模型（Schema）
- Major
```json
{ "id": 1, "majorName": "计算机科学与技术", "status": "0", "remark": "", "createTime": "2025-10-18 10:00:00", "updateTime": null }
```
- Course
```json
{ "id": 4101, "majorId": 4, "courseName": "数据结构", "courseCode": "CS-DS", "status": "0", "remark": "", "createTime": "2025-10-18 10:00:00", "updateTime": null, "majorName": "计算机科学与技术" }
```
- Resource
```json
{
  "id": 10001,
  "majorId": 4,
  "courseId": 4101,
  "resourceName": "数据结构-资料包示例",
  "resourceType": 0,
  "fileUrl": "https://oss-example/bucket/cs/ds/sample.zip",
  "fileHash": "sha256:...",
  "fileSize": 102400,
  "linkUrl": null,
  "description": "示例数据：包含笔记与课件",
  "status": 1,
  "auditBy": "admin",
  "auditTime": "2025-10-18 12:00:00",
  "auditReason": null,
  "publishTime": "2025-10-18 12:00:00",
  "downloadCount": 5,
  "lastDownloadTime": "2025-10-18 12:30:00",
  "uploaderId": 1,
  "uploaderName": "admin",
  "createTime": "2025-10-18 11:00:00",
  "updateTime": "2025-10-18 11:10:00",
  "majorName": "计算机科学与技术",
  "courseName": "数据结构"
}
```

## 门户只读接口（/portal）

### 专业列表
- GET `/portal/major/list`
- Query：`majorName?`，分页
- Resp：`{ rows: Major[], total }`

### 课程列表
- GET `/portal/course/list`
- Query：`majorId`，`courseName?`，分页

### 资源列表（仅已通过）
- GET `/portal/resource/list`
- Query：`majorId?`，`courseId?`，`keyword?`，分页

### 资源详情
- GET `/portal/resource/{id}`

### 下载（计数+302）
- GET `/portal/resource/{id}/download`
- 说明：计数成功后 302 跳转至 `fileUrl/linkUrl`

### 排行榜
- GET `/portal/resource/top`
- Query：`scope=global|major|course`（默global），`majorId?`，`courseId?`，`days?=7`，`limit?=10`
- Resp：`Resource[]`（按 `downloadCount` 降序）

## 后台管理接口（/manage）

### 专业（Major）
- GET `/manage/major/list` 权限：`manage:major:list`
- POST `/manage/major` 权限：`manage:major:add`
- PUT `/manage/major` 权限：`manage:major:edit`
- DELETE `/manage/major/{ids}` 权限：`manage:major:remove`

### 课程（Course）
- GET `/manage/course/list` 权限：`manage:course:list`
- POST `/manage/course` 权限：`manage:course:add`
- PUT `/manage/course` 权限：`manage:course:edit`
- DELETE `/manage/course/{ids}` 权限：`manage:course:remove`
- 说明：同专业下课程名唯一；负责人仅本专业。

### 资源（Resource）
- GET `/manage/courseResource/list` 权限：`manage:courseResource:list`
- GET `/manage/courseResource/{id}` 权限：`manage:courseResource:query`
- POST `/manage/courseResource` 权限：`manage:courseResource:add`
  - 文件型：`{ majorId, courseId, resourceName, resourceType:0, fileUrl, fileHash, fileSize, description }`
  - 外链型：`{ majorId, courseId, resourceName, resourceType:1, linkUrl, description }`
- PUT `/manage/courseResource` 权限：`manage:courseResource:edit`（编辑即待审）
- DELETE `/manage/courseResource/{ids}` 权限：`manage:courseResource:remove`
  - 学生：仅能删除本人“待审/驳回/已下架”；已通过需先下架
  - 负责人/管理员：可强制删除（仅删库，不删 OSS）
- PUT `/manage/courseResource/{id}/approve` 权限：`manage:courseResource:approve`
- PUT `/manage/courseResource/{id}/reject` 权限：`manage:courseResource:reject` Body：`{ reason }`
- PUT `/manage/courseResource/{id}/offline` 权限：`manage:courseResource:offline`
- PUT `/manage/courseResource/{id}/online` 权限：`manage:courseResource:online`（置为待审）
- GET `/manage/courseResource/{id}/download` 权限：`manage:courseResource:download`（后台使用，不建议前台使用）
- GET `/manage/courseResource/top` 权限：`manage:courseResource:list`

## 示例（curl）

### 门户：查询资源列表（仅已通过）
```bash
curl -H "Authorization: Bearer $TOKEN" \
  "$BASE/portal/resource/list?pageNum=1&pageSize=10&majorId=4&courseId=4101"
```

### 管理：新增（文件型）
```bash
curl -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{
  "majorId": 4,
  "courseId": 4101,
  "resourceName": "数据结构-作业合集",
  "resourceType": 0,
  "fileUrl": "https://oss/bucket/xxx.zip",
  "fileHash": "sha256:abcd...",
  "fileSize": 73400320,
  "description": "包含平时作业与解答"
}' \
  "$BASE/manage/courseResource"
```

### 审核驳回
```bash
curl -X PUT -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"reason":"外链不可达，请修正后再提交"}' \
  "$BASE/manage/courseResource/10086/reject"
```

## 备注与最佳实践
- 幂等：利用唯一索引避免重复；前端提交前可提示“检测到重复，是否继续”。
- 排序：默认 `create_time desc`；下载榜按 `download_count desc`。
- 安全：文件类型与大小后端二次校验；OSS 凭据走环境变量；敏感配置不入库/不入 Git。
- 前后端对齐：门户仅读，写操作统一走 `/manage` 并按按钮权限控制，普通用户需要写权限方可上传。

