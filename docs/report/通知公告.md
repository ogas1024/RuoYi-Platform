## 概览
- 模块：通知公告（MVP）
- 目标：支持公告发布/撤回、置顶、有效期与可见范围（全员/角色/部门/岗位），并记录阅读回执。
- 角色与权限：
  - user/librarian/major_lead：只读（list/get）
  - staff：增改删/发布/置顶（add/edit/remove/publish/pin）
  - admin/super_admin：全部

## 领域模型
```mermaid
erDiagram
  tb_notice ||--o{ tb_notice_attachment : has
  tb_notice ||--o{ tb_notice_scope : has
  tb_notice ||--o{ tb_notice_read : has

  tb_notice {
    BIGINT id PK "主键"
    VARCHAR title "标题"
    MEDIUMTEXT content_html "富文本"
    TINYINT type "1通知/2公告"
    TINYINT status "0草稿/1发布/2撤回/3过期(计算)"
    TINYINT visible_all "1全员/0自定义"
    BIGINT publisher_id "发布者"
    DATETIME publish_time
    DATETIME expire_time
    TINYINT pinned
    DATETIME pinned_time
    INT edit_count
    INT read_count
    INT attachment_count
    CHAR(1) del_flag
  }

  tb_notice_attachment {
    BIGINT id PK
    BIGINT notice_id FK
    VARCHAR file_name
    VARCHAR file_url
    VARCHAR file_type
    BIGINT file_size
    INT sort
    CHAR(1) del_flag
  }

  tb_notice_scope {
    BIGINT id PK
    BIGINT notice_id FK
    TINYINT scope_type "0角色/1部门/2岗位"
    BIGINT ref_id
    CHAR(1) del_flag
  }

  tb_notice_read {
    BIGINT id PK
    BIGINT notice_id FK
    BIGINT user_id
    TINYINT ack
    DATETIME read_time
    CHAR(1) del_flag
  }
```

## 关键流程
### 发布 / 置顶 / 撤回
```mermaid
sequenceDiagram
  actor Staff
  participant API as /manage/notice
  participant SVC as NoticeService
  participant DB as tb_*

  Staff->>API: POST /manage/notice (草稿)
  API->>SVC: add()
  SVC->>DB: insert tb_notice + 附件/范围
  Staff->>API: PUT /{id}/publish
  API->>SVC: publish(id)
  SVC->>DB: update status=1, publish_time=now()
  Staff->>API: PUT /{id}/pin {pinned:true}
  API->>SVC: pin(id,true)
  SVC->>DB: update pinned=1, pinned_time=now()
  Staff->>API: PUT /{id}/retract
  API->>SVC: retract(id)
  SVC->>DB: update status=2, pinned=0, pinned_time=null
```

### 阅读回执
```mermaid
sequenceDiagram
  actor User
  participant API as GET /manage/notice/{id}
  participant SVC as NoticeService
  participant DB as tb_notice_read

  User->>API: 请求详情
  API->>SVC: getDetailAndRecordRead(id)
  SVC->>DB: insert ignore tb_notice_read(notice_id,user_id,...)
  SVC->>DB: update tb_notice.read_count = read_count+1
  SVC-->>API: notice + attachments + scopes
```

## 权限说明
- 接口与按钮对齐：
  - manage:notice:list, manage:notice:get
  - manage:notice:add, manage:notice:edit, manage:notice:remove
  - manage:notice:publish, manage:notice:pin
- 列表过滤：
  - 默认：非管理员仅返回可见范围匹配且未过期的“已发布”。
  - 选择“全部”时：非管理员仅返回“所有已发布 + 本人草稿/撤回”。
  - 门户：支持关键词、是否包含过期、已读/未读筛选与按发布/更新/过期时间排序。

## 已知限制与后续计划
- 审批流/定时发布：后续版本支持。
- “确认已读”回执（ack=1）：MVP 未启用，已预留字段。
- 富文本图片直传：当前通过外链/OSS 后续增强压缩与鉴黄。
- 查询性能：大规模范围匹配可引入缓存与物化视图方案。

## 自检
- 表：tb_notice/tb_notice_scope/tb_notice_attachment/tb_notice_read 已在 book-mis.sql 创建并含示例数据。
- 文档：docs/api/通知公告.md、docs/apifox/通知公告.md 完整可用。
- 后端：接口/权限/事务齐备；置顶、发布、撤回齐全。
- 测试：权限注解/服务方法（成功/失败）已覆盖。
